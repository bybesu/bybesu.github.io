<!DOCTYPE html>
<html>
<head>
    <title>GeoJSON Verisini Google Uydu GÃ¶rÃ¼ntÃ¼sÃ¼ Ãœzerinde GÃ¶rÃ¼ntÃ¼leme</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        #map {
            position:fixed;
            height: 100%; 
            width: 100%;
            top:0;
            margin: 0;
            border: 1px solid #ccc;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
form {
  position: absolute;
  z-index: 1000;
  top: 20px;
  right: 20px;
  padding: 10px;
  background: #333;
  display:none;
}

#userSearch {
  height: 2.5em;
  width: 150px;
}

.ui-autocomplete {
    z-index: 2000;    
}
/* Buton iÃ§in basit stil */
#controls {
  position: absolute;
  z-index: 1500;
  top: 20px;
  left: 50px;
  padding: 0px;
  padding: 0px;
  text-align: center;
}
#locationButton {
    padding: 5px 5px;
    font-size: 16px;
    cursor: pointer;
    /* width: 30px; */
    border: none;
    border-radius: 50%;
    transition: background-color 0.3s;
}
  /* Duruma gÃ¶re renkler */
        #locationButton.start {
            background-color: #007BFF; /* Mavi - BaÅŸlat */
            color: white;
        }
        #locationButton.searching {
            background-color: #ffc107; /* SarÄ± - AranÄ±yor */
            color: black;
            cursor: not-allowed;
        }
        #locationButton.stop {
            background-color: #dc3545; /* KÄ±rmÄ±zÄ± - Durdur */
            color: white;
        }
        #locationButton:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }      
    </style>
</head>
<body>
   <div id="map"></div>
   <div id="controls">
     <button id="locationButton">ğŸ“</button>
   </div>
   <form>
     <!-- this is the element we'll target with jQuery UI -->
     <input id="userSearch" type="text" placeholder="Search for a Member" />
   </form>
</body>
  <script>
            // Not: URL'deki TÃ¼rkÃ§e karakter ("Ã§") doÄŸru bir ÅŸekilde %C3%A7 olarak kodlanmÄ±ÅŸtÄ±r.
//        const geoJsonUrl = "https://bybesu.github.io/geoJson/geojson/%C3%A7i%C3%A7ekli_kesin.json";

        const geoJsonUrl = "https://bybesu.github.io/geoJson/geojson/Ã§iÃ§ekli_kesin.json";

        // 1. HaritayÄ± BaÅŸlatma
        // 2. Google Uydu GÃ¶rÃ¼ntÃ¼sÃ¼ KatmanÄ±nÄ± Ekleme
        // Bu, Google uydu haritasÄ±nÄ± gÃ¶stermenin yaygÄ±n bir yoludur.
        // Google Maps API lisans kurallarÄ±na uygun olarak kullanmanÄ±z tavsiye edilir.
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        });

        // Google Uydu GÃ¶rÃ¼ntÃ¼sÃ¼
        const googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
            maxZoom: 20,
            subdomains:['mt0','mt1','mt2','mt3'],
            attribution: 'Map data &copy; Google Satellite'
        });
        
        // Google Arazi HaritasÄ±
        const googleTerrain = L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',{
            maxZoom: 20,
            subdomains:['mt0','mt1','mt2','mt3'],
            attribution: 'Map data &copy; Google Terrain'
        });

   const googleHybrid = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
});    
    
    const googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
});
        // KaranlÄ±k Mod (CartoDB) - Veri gÃ¶stermek iÃ§in gÃ¼zeldir
        const cartoDark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://carto.com/attributions">CARTO</a>'
        });
var Stadia_AlidadeSatellite = L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_satellite/{z}/{x}/{y}{r}.{ext}', {
	minZoom: 0,
	maxZoom: 20,
	attribution: '&copy; CNES, Distribution Airbus DS, Â© Airbus DS, Â© PlanetObserver (Contains Copernicus Data) | &copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
	ext: 'jpg'
});
        // SeÃ§enekleri bir nesnede topla (KullanÄ±cÄ±ya gÃ¶rÃ¼necek isimler)
        const baseMaps = {
            "Google Uydu": googleSat,
            "Google Hibrit": googleHybrid,
            "Google Sokak":googleStreets,
            "Sokak HaritasÄ± (OSM)": osm,
            "Google Arazi": googleTerrain,
            "KaranlÄ±k Mod": cartoDark,
            "Stadia_AlidadeSatellite":Stadia_AlidadeSatellite
        };

const map = L.map('map', {
            center: [40.00, 30.00], // VarsayÄ±lan: Bursa
            zoom: 13,
            layers: [googleSat] // HaritanÄ±n varsayÄ±lan olarak hangi altlÄ±kla aÃ§Ä±lacaÄŸÄ±
        });
L.control.layers(baseMaps).addTo(map);
    // https://leaflet-extras.github.io/leaflet-providers/preview/
        // 3. GeoJSON Verisini YÃ¼kleme
        fetch(geoJsonUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('AÄŸ yanÄ±tÄ± baÅŸarÄ±sÄ±z oldu.');
                }
                return response.json();
            })
            .then(data => {
          debugger;
          const geoJsonData = convertArrayToGeoJSONFeatureCollection(data);

                // 4. GeoJSON KatmanÄ±nÄ± OluÅŸturma ve Haritaya Ekleme
                const geoJsonLayer = L.geoJSON(geoJsonData, {
                    // Stilleme Fonksiyonu
                    style: function(feature) {
                        // Uydu gÃ¶rÃ¼ntÃ¼sÃ¼ Ã¼zerinde daha iyi gÃ¶rÃ¼nmesi iÃ§in parlak renkler kullanÄ±ldÄ±
                        return {
                            color: "#FFFF00",       // KenarlÄ±k rengi (SarÄ±)
                            weight: 1,
                            opacity: 1,
                            fillColor: "#FF00FF",   // Dolgu rengi (Parlak Eflatun)
                            fillOpacity: 0.15      // Hafif ÅŸeffaf dolgu
                        };
                    },
                    // Her bir Ã¶ÄŸe iÃ§in Popup Ekleme
                    onEachFeature: function (feature, layer) {
                       if (feature.properties) {
                    // Sahip bilgilerini Ã§ek ve formatla
                    let kisiList = feature.properties.CalismaAlaniDosyaParselKisiList;
                    let sahipler = kisiList.map(kisi => {
                        let pay = `${kisi.Pay}/${kisi.Payda}`;
                        return `${kisi.Ad} ${kisi.Soyad} (${pay})`;
                    }).join('<br>');

                    let htmlContent = `
                        <h4>Parsel Bilgisi: ${feature.properties.GidenParselNo}</h4>
                        <hr>
                        <p><b>Ada/Parsel:</b> ${feature.properties.GidenAdaNo}/${feature.properties.GidenParselNo}</p>
                        <p><b>Nitelik:</b> ${feature.properties.GidenNitelik}</p>
                        <p><b>Alan:</b> ${feature.properties.GidenAlan} mÂ²</p>
                        <p><b>Sahipler:</b> <br>${sahipler}</p>
                    `;
                    layer.bindPopup(htmlContent);
                }
                    }
                }).addTo(map);

                // 5. HaritayÄ± Verinin SÄ±nÄ±rlarÄ±na Ayarlama
                if (geoJsonLayer.getLayers().length > 0) {
                    map.fitBounds(geoJsonLayer.getBounds());
                }
            })

            .catch(error => {
                debugger;
                console.error("GeoJSON yÃ¼klenirken bir hata oluÅŸtu:", error);
                alert("GeoJSON verisi yÃ¼klenemedi. Konsolu kontrol edin.");
            });

    
        function parseWKTCoordinates(wktString) {
            if (!wktString) return [];
            
            // MULTIPOLYGON'un dÄ±ÅŸ ve iÃ§ parantezlerini temizle
            const coordinatesString = wktString
                .replace(/^MULTIPOLYGON\(\(\(/, "") 
                .replace(/\)\)\)$/, "")
                .trim();
            
            if (!coordinatesString) {
                return [];
            }
            
            // Birden fazla halka (Ring) veya delik (Hole) varsa ayÄ±r.
            const polygonRings = coordinatesString.split(')),(');

            const multiPolygon = polygonRings.map(ringString => {
                // Parantezleri temizle (iÃ§ delikler iÃ§in)
                const cleanedRingString = ringString.replace(/\(|\)/g, '').trim();

                const pairs = cleanedRingString.split(',');

                const polygonCoordinates = pairs.map(pair => {
                    const [lonStr, latStr] = pair.trim().split(/\s+/);
                    return [parseFloat(lonStr), parseFloat(latStr)];
                });
                return polygonCoordinates;
            });

            // GeoJSON MultiPolygon formatÄ±: [[[Ring Coords], [Hole Coords]], [[Next Polygon]]]
            // Bu Ã¶rnekte tek bir Ã§okgen (MultiPolygon) iÃ§inde birden fazla halka olabilir.
            return [multiPolygon]; 
        }

        /**
         * WKT iÃ§eren nesne dizisini geÃ§erli bir GeoJSON FeatureCollection'a dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r.
         */
        function convertArrayToGeoJSONFeatureCollection(dataArray) {
            const newFeatures = dataArray.map(feature => {
                const newFeature = { 
                    type: "Feature", 
                    properties: { ...feature } 
                };

                if (feature.GeomWKT) {
                    newFeature.geometry = {
                        type: "MultiPolygon",
                        coordinates: parseWKTCoordinates(feature.GeomWKT)
                    };
                    delete newFeature.properties.GeomWKT;
                }
                
                return newFeature;
            });

            return {
                type: "FeatureCollection",
                features: newFeatures
            };
        }
    
let marker, circle;
        let ilkKonumBulundu = false;
        let watchId = null; // Konum izleme iÅŸleminin ID'sini (durumunu) tutar
        const locationButton = document.getElementById('locationButton');

        // --- 1. BUTONA TIKLAMA OLAYI (AÃ‡/KAPAT) ---
        
        locationButton.addEventListener('click', () => {
            if (watchId) {
                // Konum takibi ZATEN AKTÄ°FSE (DURDURMA MODU)
                stopLocationWatch();
            } else {
                // Konum takibi KAPALIYSA (BAÅLATMA MODU)
                startLocationWatch();
            }
        });

        // --- 2. KONUM Ä°ZLEMEYÄ° BAÅLATAN FONKSÄ°YON ---
        function startLocationWatch() {
            if (!navigator.geolocation) {
                alert("TarayÄ±cÄ±nÄ±z Geolocation API'sini desteklemiyor.");
                return;
            }

            // Butonu "AranÄ±yor" durumuna getir
            locationButton.textContent = "Konum AranÄ±yor...";
            locationButton.className = "searching";
            locationButton.disabled = true; 

            // YÃ¼ksek doÄŸrulukta izlemeyi baÅŸlat
            watchId = navigator.geolocation.watchPosition(onSuccess, onError, {
                enableHighAccuracy: true,
                timeout: 10000, // Zaman aÅŸÄ±mÄ±nÄ± 10 saniyeye Ã§Ä±kardÄ±k
                maximumAge: 0
            });
        }

        // --- 3. KONUM Ä°ZLEMEYÄ° DURDURAN FONKSÄ°YON ---
        function stopLocationWatch() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId); // Takibi durdur
                watchId = null; // Durumu sÄ±fÄ±rla

                // Butonu "BaÅŸlat" moduna dÃ¶ndÃ¼r
                locationButton.textContent = "ğŸ“";
                locationButton.className = "start";
                locationButton.disabled = false;

                // Haritadan iÅŸaretÃ§i ve daireyi kaldÄ±r
                if (marker) {
                    map.removeLayer(marker);
                    marker = null;
                }
                if (circle) {
                    map.removeLayer(circle);
                    circle = null;
                }
                
                // Harita odaÄŸÄ±nÄ± sÄ±fÄ±rla
                ilkKonumBulundu = false;
                
                // Popup'Ä± kapat (eÄŸer aÃ§Ä±ksa)
                map.closePopup();
            }
        }


        // --- 4. YARDIMCI FONKSÄ°YONLAR (onSuccess ve onError) ---

        // Konum BaÅŸarÄ±yla BulunduÄŸunda
        function onSuccess(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const accuracy = position.coords.accuracy;

            // Butonu "Durdur" moduna getir ve aktifleÅŸtir
            locationButton.textContent = "ğŸ›‘";
            locationButton.className = "stop";
            locationButton.disabled = false;
            
            if (!marker) {
                // Ä°lk kez bulunduysa, iÅŸaretÃ§i ve daireyi oluÅŸtur
                marker = L.marker([lat, lon]).addTo(map);
                circle = L.circle([lat, lon], {
                    radius: accuracy,
                    color: '#007BFF',
                    fillColor: '#007BFF',
                    fillOpacity: 0.15
                }).addTo(map);
            } else {
                // Zaten varsa, konumlarÄ±nÄ± gÃ¼ncelle
                marker.setLatLng([lat, lon]);
                circle.setLatLng([lat, lon]);
                circle.setRadius(accuracy);
            }

            marker.bindPopup(`<b>Konumunuz</b><br>DoÄŸruluk: ${accuracy.toFixed(0)} metre`);

            // Sadece ilk bulunduÄŸunda haritayÄ± odakla
            if (!ilkKonumBulundu) {
                map.setView([lat, lon], 16);
                ilkKonumBulundu = true;
                marker.openPopup(); // Ä°lk bulunduÄŸunda popup'Ä± aÃ§
            }
        }

        // Konum AlÄ±nÄ±rken Hata Olursa
        function onError(error) {
            let message = "";
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = "KullanÄ±cÄ± konum iznini reddetti.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = "Konum bilgisi ÅŸu anda mevcut deÄŸil.";
                    break;
                case error.TIMEOUT:
                    message = "Konum bilgisi alma isteÄŸi zaman aÅŸÄ±mÄ±na uÄŸradÄ±.";
                    break;
                default:
                    message = "Bilinmeyen bir hata oluÅŸtu.";
            }
            alert("Hata: " + message);

            // Hata durumunda takibi durdur ve her ÅŸeyi sÄ±fÄ±rla
            stopLocationWatch();

            if (error.code === error.PERMISSION_DENIED) {
                 locationButton.textContent = "Ä°zin Reddedildi";
                 locationButton.disabled = true; // Ä°zin reddedildiyse butonu kilitle
            }
        }    
  </script>
</html>